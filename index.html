<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macroeconom√≠a - Dr. Adri√°n Eduardo Pech Quijano</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        :root { --blue: #1e40af; --red: #b91c1c; --green: #065f46; --orange: #c2410c; --slate: #334155; --uac-gold: #b89c5e; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; margin: 0; padding: 20px; color: #1e293b; }
        
        #welcome-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(248, 250, 252, 0.98);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #exercise-guide {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .guide-card {
            background: white;
            max-width: 650px;
            width: 95%;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-height: 85vh;
            overflow-y: auto;
        }

        .welcome-card {
            background: white;
            max-width: 850px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .header-inst { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--slate); padding-bottom: 15px; }
        .header-inst h1 { margin: 0; font-size: 1.6rem; color: var(--slate); }
        .header-inst p { margin: 5px 0; font-weight: 500; }
        
        .uac-shield { 
            width: 120px; 
            height: auto; 
            margin: 0 auto 15px auto; 
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .wrapper { 
            max-width: 1500px; 
            margin: auto; 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 20px; 
            height: calc(100vh - 180px);
        }
        .sidebar { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            height: calc(100vh - 220px); 
            overflow-y: auto; 
            position: sticky; 
            top: 0;
        }
        .main-content { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            overflow-y: auto; 
            padding-right: 10px;
        }

        .formula-card { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.4; border-left: 4px solid var(--blue); }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-weight: 600; font-size: 0.8rem; margin-bottom: 3px; color: var(--slate); }
        input[type="range"] { width: 100%; cursor: pointer; }
        .val-display { float: right; color: var(--blue); font-weight: bold; }
        
        .delta-badge { font-size: 0.7rem; padding: 1px 5px; border-radius: 4px; margin-left: 5px; font-weight: 800; display: inline-block; vertical-align: middle; }
        .delta-pos { background: #dcfce7; color: #166534; }
        .delta-neg { background: #fee2e2; color: #991b1b; }

        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 380px; }
        .logic-panel { background: #fff; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; }
        
        .instructional-content h3 { color: var(--blue); margin-top: 20px; font-size: 1.2rem; border-left: 4px solid var(--uac-gold); padding-left: 10px; }
        .instructional-content p, .instructional-content li { font-size: 0.95rem; line-height: 1.6; color: #334155; }
        .instructional-content strong { color: var(--blue); }
        
        #stability-alert { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; }
        .btn-panic { background: #991b1b; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn-action { background: var(--slate); color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn-guide { background: var(--uac-gold); color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 8px; transition: 0.3s; }
        .btn-guide:hover { background: #9c844a; }
        .btn-start { background: var(--blue); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 25px; transition: 0.3s; }
        .btn-start:hover { background: #172554; }

        .academic-credits {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-top: 10px;
            border-top: 5px solid var(--uac-gold);
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 25px;
            align-items: center;
        }
        .credit-info h4 { margin: 0 0 8px 0; color: var(--blue); font-size: 1.1rem; }
        .credit-info p { margin: 4px 0; font-size: 0.85rem; color: var(--slate); }
        .credit-logo { text-align: center; border-right: 1px solid #e2e8f0; padding-right: 20px; }
        
        .exercise-item { margin-bottom: 15px; padding: 10px; border-left: 4px solid var(--uac-gold); background: #f8fafc; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>

<div id="welcome-overlay">
    <div class="welcome-card">
        <div class="header-inst">
            <img src="uac-logo-2020-sm.png" alt="Escudo Universidad Aut√≥noma de Campeche" class="uac-shield">
            <h1>Universidad Aut√≥noma de Campeche</h1>
            <p>Facultad de Ciencias Sociales | Licenciatura en Econom√≠a</p>
            <p style="color: var(--blue); font-size: 1.1rem;">Unidad de Aprendizaje: Macroeconom√≠a</p>
            <p>Autor: <strong>Dr. Adri√°n Eduardo Pech Quijano</strong></p>
            <p style="font-size: 0.9rem; color: var(--slate);">Fecha: 26 de enero de 2026</p>
        </div>
        
        <div class="instructional-content">
            <h3>Descripci√≥n del material inform√°tico e in√©dito</h3>
            <p>Este software educativo interactivo representa un <strong>objeto de aprendizaje (OA)</strong> original, desarrollado para modelar de forma algor√≠tmica y visual el equilibrio en una econom√≠a abierta. A diferencia de las gr√°ficas est√°ticas, este material permite la <strong>experimentaci√≥n en tiempo real</strong> con variables ex√≥genas, proporcionando una soluci√≥n num√©rica instant√°nea a las identidades macroecon√≥micas fundamentales.</p>
            
            <h3>Gu√≠a instruccional del objeto de aprendizaje</h3>
            
            <p><strong>1. Objetivos de aprendizaje:</strong></p>
            <ul>
                <li>Identificar y cuantificar el efecto del <strong>multiplicador del gasto (Œ±)</strong> bajo un r√©gimen impositivo proporcional y propensi√≥n marginal a importar.</li>
                <li>Simular escenarios de pol√≠tica fiscal expansiva y contractiva para observar su impacto en el producto interno bruto (PIB).</li>
                <li>Analizar la interacci√≥n entre el ahorro nacional, la inversi√≥n y el saldo de la cuenta comercial (Identidad S - I = NX).</li>
            </ul>

            <p><strong>2. Desarrollo del proceso:</strong></p>
            <ul>
                <li><strong>Manipulaci√≥n de variables:</strong> Utilice los controles deslizantes de la izquierda para modificar el gasto (G), impuestos (T), tipo de cambio (e) y el ingreso externo (Y*).</li>
                <li><strong>Observaci√≥n din√°mica:</strong> Analice c√≥mo los puntos de equilibrio se desplazan simult√°neamente en los cuatro gr√°ficos (demanda agregada, presupuesto, sector externo y ahorro-inversi√≥n).</li>
                <li><strong>Escenarios comparativos:</strong> Utilice el bot√≥n "Fijar escenario base" para establecer una l√≠nea de referencia y visualizar los cambios marginales (badges verdes/rojos) tras nuevas modificaciones.</li>
            </ul>

            <p><strong>3. Conclusi√≥n y verificaci√≥n:</strong></p>
            <p>El proceso culmina en la <strong>consolidaci√≥n del equilibrio</strong>. El estudiante debe verificar que, independientemente de los choques aplicados, la identidad macroecon√≥mica se mantiene constante, demostrando que el d√©ficit comercial debe ser financiado necesariamente por un exceso de inversi√≥n sobre el ahorro nacional o viceversa.</p>
        </div>

        <button class="btn-start" onclick="document.getElementById('welcome-overlay').style.display='none'">
            Ingresar al simulador
        </button>
    </div>
</div>

<div id="exercise-guide" onclick="this.style.display='none'">
    <div class="guide-card" onclick="event.stopPropagation()">
        <h2 style="color: var(--blue); border-bottom: 2px solid var(--uac-gold); padding-bottom: 10px; margin-top: 0;">Gu√≠a de ejercicios pr√°cticos</h2>
        <div style="font-size: 0.95rem; line-height: 1.6; color: var(--slate);">
            
            <div class="exercise-item">
                <strong>Ejercicio 1: Sensibilidad del consumo y multiplicador</strong><br>
                1. Haga clic en <b>"Fijar escenario base"</b>.<br>
                2. Aumente la <b>Propensi√≥n marginal a consumir (c)</b> de 0.60 a 0.80.<br>
                3. Observe la tarjeta naranja: ¬øQu√© sucedi√≥ con el <b>Multiplicador (Œ±)</b>? <br>
                4. Ahora aumente el <b>Gasto (G)</b> en 200 unidades. Compare el crecimiento del PIB con este multiplicador alto frente al escenario original.
            </div>

            <div class="exercise-item">
                <strong>Ejercicio 2: Inversi√≥n, tasa de inter√©s y pol√≠tica monetaria</strong><br>
                1. Restablezca el escenario base. En este modelo, la inversi√≥n se define como <b>I = I‚ÇÄ + bY - gi</b>.<br>
                2. Suponga que el banco central reduce la <b>Tasa de inter√©s (i)</b>. Observe c√≥mo reacciona la inversi√≥n y el PIB.<br>
                3. Observe el <b>Gr√°fico IV (S-I)</b>: ¬øC√≥mo afecta una mayor inversi√≥n al equilibrio entre el ahorro nacional y las exportaciones netas?
            </div>
            
            <div class="exercise-item">
                <strong>Ejercicio 3: El consumo aut√≥nomo y la demanda agregada</strong><br>
                1. Restablezca el simulador y fije base. Aumente el <b>Consumo aut√≥nomo (C‚ÇÄ)</b> a 750.<br>
                2. Observe el Gr√°fico I: ¬øC√≥mo se desplaza la curva DA? <br>
                3. Verifique el nuevo nivel de <b>Ahorro privado</b>. ¬øPor qu√© un mayor consumo aut√≥nomo reduce inicialmente el ahorro si el ingreso no aumenta proporcionalmente?
            </div>
            
            <div class="exercise-item">
                <strong>Ejercicio 4: Pol√≠tica fiscal y d√©ficits gemelos</strong><br>
                1. Reduzca la <b>Tasa impositiva (t)</b> a 0.10 y aumente <b>G</b> a 2500.<br>
                2. Observe el <b>Saldo fiscal</b> y las <b>Exportaciones netas (NX)</b>. <br>
                3. Analice c√≥mo el aumento del ingreso (estimulado por la baja de impuestos y el consumo) termina deteriorando la balanza comercial.
            </div>

            <div class="exercise-item">
                <strong>Ejercicio 5: Identidad S-I en econom√≠a abierta</strong><br>
                1. Realice cambios en <b>Y* (PIB mundial)</b> y <b>e (Tipo de cambio)</b>.<br>
                2. Compruebe que la diferencia entre ahorro nacional e inversi√≥n siempre iguala a NX. Explique c√≥mo el sector externo financia las brechas de ahorro dom√©stico.
            </div>
        </div>
        <button class="btn-action" style="margin-top: 20px; background: var(--blue);" onclick="document.getElementById('exercise-guide').style.display='none'">Continuar con la simulaci√≥n</button>
    </div>
</div>

<div class="header-inst">
    <img src="uac-logo-2020-sm.png" alt="Escudo UAC" class="uac-shield" style="width: 80px;">
    <h1>Universidad Aut√≥noma de Campeche</h1>
    <p>Facultad de Ciencias Sociales | Macroeconom√≠a</p>
    <p>Autor: Dr. Adri√°n Eduardo Pech Quijano</p>
</div>

<div class="wrapper">
    <div class="sidebar">
        <div class="formula-card">
            <strong>Ecuaciones del modelo:</strong><br>
            ‚Ä¢ C = C‚ÇÄ + c(Y - T)<br>
            ‚Ä¢ I = I‚ÇÄ + bY - gi<br>
            ‚Ä¢ T = T‚ÇÄ + tY<br>
            ‚Ä¢ IM = IM‚ÇÄ + mY + n_im * e<br>
            ‚Ä¢ X = X‚ÇÄ + x_ext * Y* - n_ex * e<br>
            ‚Ä¢ NX = X - IM<br>
            ‚Ä¢ DA = C + I + G + NX<br>
            ‚Ä¢ Œ± = 1 / [1 - c(1-t) - b + m]
        </div>
        
        <div class="control-group">
            <label>Consumo aut√≥nomo (C‚ÇÄ): <span id="vC0" class="val-display">250</span></label>
            <input type="range" id="iC0" min="0" max="1000" step="50" value="250" oninput="update()">
        </div>
        <div class="control-group">
            <label>Propensi√≥n marginal a consumir (c): <span id="vc" class="val-display">0.60</span></label>
            <input type="range" id="ic" min="0.1" max="0.9" step="0.05" value="0.60" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <div class="control-group">
            <label>Inversi√≥n aut√≥noma (I‚ÇÄ): <span id="vI0" class="val-display">500</span></label>
            <input type="range" id="iI0" min="0" max="1500" step="50" value="500" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad al ingreso (b): <span id="vb" class="val-display">0.20</span></label>
            <input type="range" id="ib" min="0" max="0.4" step="0.01" value="0.20" oninput="update()">
        </div>
        <div class="control-group">
            <label>Tasa de inter√©s (i): <span id="vi" class="val-display">0.05</span></label>
            <input type="range" id="ii" min="0.01" max="0.2" step="0.01" value="0.05" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad al inter√©s (g): <span id="vg" class="val-display">1000</span></label>
            <input type="range" id="ig" min="0" max="5000" step="100" value="1000" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

        <div class="control-group">
            <label>Gasto p√∫blico (G): <span id="vG" class="val-display">2000</span></label>
            <input type="range" id="iG" min="500" max="4000" step="100" value="2000" oninput="update()">
        </div>
        <div class="control-group">
            <label>Impuestos aut√≥nomos (T‚ÇÄ): <span id="vT0" class="val-display">0</span></label>
            <input type="range" id="iT0" min="0" max="1000" step="50" value="0" oninput="update()">
        </div>
        <div class="control-group">
            <label>Tasa impositiva (t): <span id="vt" class="val-display">0.20</span></label>
            <input type="range" id="it" min="0" max="0.4" step="0.01" value="0.20" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

        <div class="control-group">
            <label>Exportaciones aut√≥nomas (X‚ÇÄ): <span id="vX0" class="val-display">500</span></label>
            <input type="range" id="iX0" min="0" max="2000" step="100" value="500" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad ingreso externo (x_ext): <span id="vx_ext" class="val-display">0.20</span></label>
            <input type="range" id="ix_ext" min="0" max="0.5" step="0.01" value="0.20" oninput="update()">
        </div>
        <div class="control-group">
            <label>PIB mundial (Y*): <span id="vYstar" class="val-display">5000</span></label>
            <input type="range" id="iYstar" min="2000" max="8000" step="100" value="5000" oninput="update()">
        </div>
        <div class="control-group">
            <label>Importaciones aut√≥nomas (IM‚ÇÄ): <span id="vIM0" class="val-display">100</span></label>
            <input type="range" id="iIM0" min="0" max="1000" step="50" value="100" oninput="update()">
        </div>
        <div class="control-group">
            <label>Propensi√≥n marginal a importar (m): <span id="vm" class="val-display">0.10</span></label>
            <input type="range" id="im" min="0.05" max="0.4" step="0.01" value="0.10" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

        <div class="control-group">
            <label>Tipo de cambio (e): <span id="ve" class="val-display">20.00</span></label>
            <input type="range" id="ie" min="15" max="25" step="0.5" value="20.00" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad NX al TC (n): <span id="vn" class="val-display">20</span></label>
            <input type="range" id="in" min="0" max="100" step="5" value="20" oninput="update()">
        </div>

        <div id="stability-alert" style="display:none;">‚ö†Ô∏è El modelo es inestable (Denominador ‚â§ 0)</div>
        <button class="btn-action" onclick="setBase()">Fijar escenario base</button>
        <button class="btn-guide" onclick="document.getElementById('exercise-guide').style.display='flex'">Ver gu√≠a de ejercicios</button>
        <button class="btn-panic" onclick="location.reload()">Restablecer simulador</button>
        <button class="btn-action" style="background: #065f46; margin-top: 8px;" onclick="exportToCSV()">
                    üì• Exportar Escenario (CSV)
                    </button>
    </div>

    <div class="main-content">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="chart-box"><canvas id="chartDA"></canvas></div>
            <div class="chart-box"><canvas id="chartT"></canvas></div>
            <div class="chart-box"><canvas id="chartNX"></canvas></div>
            <div class="chart-box"><canvas id="chartTheory"></canvas></div>
        </div>

<div class="logic-panel">
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
        
        <div style="background: #fff7ed; padding: 25px; border-radius: 8px; border: 1px solid #ffedd5; text-align: center;">
            <label style="color: #9a3412; font-size: 1rem;">Multiplicador (Œ±)</label>
            <div id="res_alpha" class="res-val" style="font-size: 2.2rem; color: #c2410c;">-</div>
        </div>
        <div style="background: #f0fdf4; padding: 25px; border-radius: 8px; border: 1px solid #dcfce7; text-align: center;">
            <label style="color: #166534; font-size: 1rem;">PIB Equilibrio (Y*)</label>
            <div id="res_Y" class="res-val" style="font-size: 2.2rem; color: #15803d;">-</div>
        </div>
        <div style="background: #fdf2f2; padding: 25px; border-radius: 8px; border: 1px solid #fee2e2; text-align: center;">
            <label style="color: #991b1b; font-size: 1rem;">Saldo Fiscal (BS)</label>
            <div id="res_BS" class="res-val" style="font-size: 2.2rem; color: #b91c1c;">-</div>
        </div>
        <div style="background: #f0f9ff; padding: 25px; border-radius: 8px; border: 1px solid #e0f2fe; text-align: center;">
            <label style="color: #0369a1; font-size: 1rem;">Export. Netas (NX)</label>
            <div id="res_NX" class="res-val" style="font-size: 2.2rem; color: #1d4ed8;">-</div>
        </div>

        <div style="background: #eff6ff; padding: 25px; border-radius: 8px; border: 1px solid #dbeafe; text-align: center;">
            <label style="color: #1e40af; font-size: 1rem;">Consumo (C)</label>
            <div id="res_C" class="res-val" style="font-size: 2.2rem; color: #1e40af;">-</div>
        </div>
        <div style="background: #f8fafc; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
            <label style="color: #334155; font-size: 1rem;">Inversi√≥n (I)</label>
            <div id="res_I" class="res-val" style="font-size: 2.2rem; color: #334155;">-</div>
        </div>
        <div style="background: #f0fdf4; padding: 25px; border-radius: 8px; border: 1px solid #dcfce7; text-align: center;">
            <label style="color: #065f46; font-size: 1rem;">Ahorro Privado (Sp)</label>
            <div id="res_Sp" class="res-val" style="font-size: 2.2rem; color: #065f46;">-</div>
        </div>
        <div style="background: #fffbeb; padding: 25px; border-radius: 8px; border: 1px solid #fef3c7; text-align: center;">
            <label style="color: #92400e; font-size: 1rem;">Identidad (S - I)</label>
            <div id="res_SI" class="res-val" style="font-size: 2.2rem; color: #b89c5e;">-</div>
        </div>
        <div style="background: #fdf4ff; padding: 25px; border-radius: 8px; border: 1px solid #fae8ff; text-align: center;">
        <label style="color: #701a75; font-size: 1rem;">Ahorro Nacional (S)</label>
        <div id="res_S" class="res-val" style="font-size: 2.2rem; color: #a21caf;">-</div>
        </div>
        <div style="background: #f0fdfa; padding: 25px; border-radius: 8px; border: 1px solid #ccfbf1; text-align: center;">
        <label style="color: #134e4a; font-size: 1rem;">Ingreso Disponible (Yd)</label>
        <div id="res_Yd" class="res-val" style="font-size: 2.2rem; color: #0f766e;">-</div>
        </div>
        <div style="background: #fefce8; padding: 25px; border-radius: 8px; border: 1px solid #fef9c3; text-align: center;">
        <label style="color: #854d0e; font-size: 1rem;">Brecha (Sp - I)</label>
        <div id="res_SpI" class="res-val" style="font-size: 2.2rem; color: #a16207;">-</div>
        </div>
       <div style="background: #fff1f2; padding: 25px; border-radius: 8px; border: 1px solid #ffe4e6; text-align: center;">
       <label style="color: #9f1239; font-size: 1rem;">Ahorro Externo (-NX)</label>
       <div id="res_SX" class="res-val" style="font-size: 2.2rem; color: #be123c;">-</div>
       </div>
    </div>
</div>

        <div class="academic-credits">
            <div class="credit-logo">
                <img src="uac-logo-2020-sm.png" alt="UAC" style="width: 80px;">
            </div>
            <div class="credit-info">
                <h4>Cr√©ditos acad√©micos</h4>
                <p><strong>Desarrollo t√©cnico y conceptual:</strong> Dr. Adri√°n Eduardo Pech Quijano</p>
                <p><strong>Instituci√≥n:</strong> Universidad Aut√≥noma de Campeche | Facultad de Ciencias Sociales</p>
                <p><strong>Prop√≥sito:</strong> Material did√°ctico in√©dito para la Licenciatura en Econom√≠a (Macroeconom√≠a).</p>
                <p>¬© 2026 Universidad Aut√≥noma de Campeche. Todos los derechos reservados.</p>
            </div>
        </div>
    </div>
</div>

<script>
    let charts = {};
    let baseScenario = null;

    const chartTitles = {
        DA: 'I. Equilibrio demanda agregada (45¬∞)',
        T: 'II. Presupuesto p√∫blico (T - G)',
        NX: 'III. Sector externo (X - IM)',
        Theory: 'IV. Identidad ahorro-inversi√≥n (S - I = NX)'
    };

    function setBase() {
    const p = getParams();
    const res = calculate(p);
    // Guardamos tanto los par√°metros como los resultados calculados
    baseScenario = { ...p, ...res }; 
    
    // Feedback visual para el usuario
    const btn = document.querySelector('.btn-action[onclick="setBase()"]');
    const originalText = btn.innerText;
    btn.innerText = "‚úÖ Escenario base guardado";
    btn.style.background = "var(--green)";
    
    setTimeout(() => {
        btn.innerText = originalText;
        btn.style.background = "var(--slate)";
    }, 2000);

    update(); // Refrescamos para que aparezcan las comparativas si ya existen
}

    function getParams() {
        return {
            C0: parseFloat(document.getElementById('iC0').value),
            c: parseFloat(document.getElementById('ic').value),
            I0: parseFloat(document.getElementById('iI0').value),
            b: parseFloat(document.getElementById('ib').value),
            i: parseFloat(document.getElementById('ii').value),
            g: parseFloat(document.getElementById('ig').value),
            G: parseFloat(document.getElementById('iG').value),
            T0: parseFloat(document.getElementById('iT0').value),
            t: parseFloat(document.getElementById('it').value),
            X0: parseFloat(document.getElementById('iX0').value),
            x_ext: parseFloat(document.getElementById('ix_ext').value),
            Ystar: parseFloat(document.getElementById('iYstar').value),
            IM0: parseFloat(document.getElementById('iIM0').value),
            m: parseFloat(document.getElementById('im').value),
            e: parseFloat(document.getElementById('ie').value),
            n: parseFloat(document.getElementById('in').value)
        };
    }

    function calculate(p) {
        // Gasto aut√≥nomo consolidado (A)
        // Se asume n_im = n/2 y n_ex = n/2 seg√∫n la l√≥gica de tus gr√°ficos anteriores
        const A = p.C0 - p.c * p.T0 + p.I0 - p.g * p.i + p.G + p.X0 + (p.x_ext * p.Ystar) - p.IM0 - (p.n * p.e);
        
        const den = 1 - p.c * (1 - p.t) - p.b + p.m;
        const alpha = 1 / den;
        const Y_eq = A * alpha;
        
        const T = p.T0 + p.t * Y_eq;
        const C = p.C0 + p.c * (Y_eq - T);
        const I = p.I0 + p.b * Y_eq - p.g * p.i;
        const BS = T - p.G;
        const Sp = Y_eq - T - C;
        
        // NX = (X0 + x_ext*Y* - (n/2)*e) - (IM0 + m*Y + (n/2)*e)
        const X = p.X0 + p.x_ext * p.Ystar - (p.n / 2) * p.e;
        const IM = p.IM0 + p.m * Y_eq + (p.n / 2) * p.e;
        const NX = X - IM;

        return { alpha, Y_eq, T, C, I, NX, BS, Sp, den, A };
    }

function update() {
    const p = getParams();
    const res = calculate(p);

    // 1. Actualizaci√≥n de etiquetas de los Sliders
    const ids = ['C0', 'c', 'I0', 'b', 'i', 'g', 'G', 'T0', 't', 'X0', 'x_ext', 'Ystar', 'IM0', 'm', 'e', 'n'];
    ids.forEach(id => {
        const el = document.getElementById('v' + id);
        if(el) {
            el.innerText = (['c', 'b', 't', 'm', 'x_ext', 'i'].includes(id)) 
                ? p[id].toFixed(2) 
                : Math.round(p[id]).toLocaleString();
        }
    });

    const isStable = res.den > 0;
    document.getElementById('stability-alert').style.display = isStable ? 'none' : 'block';

    // Lista extendida de IDs para resultados
    const resultsIds = [
        'res_alpha', 'res_Y', 'res_BS', 'res_NX', 
        'res_C', 'res_I', 'res_Sp', 'res_SI',
        'res_S', 'res_Yd', 'res_SpI', 'res_SX'
    ];

    if (isStable && res.Y_eq > 0) {
        // 2. C√°lculos de las nuevas identidades
        const Yd = res.Y_eq - res.T;             // Ingreso Disponible
        const S_nacional = res.Sp + res.BS;      // Ahorro Nacional (Total)
        const SpI = res.Sp - res.I;              // Brecha de ahorro del sector privado
        const SI_total = S_nacional - res.I;     // Identidad Fundamental (S - I)
        const SX = -res.NX;                      // Ahorro Externo (Entrada de capitales)

        // 3. Renderizado de valores en el panel
        document.getElementById('res_alpha').innerText = res.alpha.toFixed(2);
        document.getElementById('res_Y').innerText     = Math.round(res.Y_eq).toLocaleString();
        document.getElementById('res_BS').innerText    = Math.round(res.BS).toLocaleString();
        document.getElementById('res_NX').innerText    = Math.round(res.NX).toLocaleString();
        document.getElementById('res_C').innerText     = Math.round(res.C).toLocaleString();
        document.getElementById('res_I').innerText     = Math.round(res.I).toLocaleString();
        document.getElementById('res_Sp').innerText    = Math.round(res.Sp).toLocaleString();
        
        // Valores de la nueva fila de identidades
        document.getElementById('res_SI').innerText    = Math.round(SI_total).toLocaleString();
        document.getElementById('res_S').innerText     = Math.round(S_nacional).toLocaleString();
        document.getElementById('res_Yd').innerText    = Math.round(Yd).toLocaleString();
        document.getElementById('res_SpI').innerText   = Math.round(SpI).toLocaleString();
        document.getElementById('res_SX').innerText    = Math.round(SX).toLocaleString();

        renderCharts(p, res);
    } else {
        // En caso de error o inestabilidad, resetear todos los campos
        resultsIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerText = "---";
        });
    }
}
    function renderCharts(p, res) {
        const max_X = Math.max(15000, res.Y_eq * 1.5);
        const labels = Array.from({ length: 21 }, (_, i) => (max_X / 20) * i);

        const datasets = {
            DA: [
                { label: 'DA = A + [1-(1/Œ±)]Y', data: labels.map(y => res.A + (1 - 1 / res.alpha) * y), borderColor: '#1e40af', borderWidth: 3 },
                { label: 'L√≠nea 45¬∞', data: labels, borderColor: '#94a3b8', borderDash: [5, 5] }
            ],
            T: [
                { label: 'Recaudaci√≥n (T)', data: labels.map(y => p.T0 + p.t * y), borderColor: '#065f46' },
                { label: 'Gasto (G)', data: labels.map(() => p.G), borderColor: '#b91c1c', borderDash: [2, 2] }
            ],
            NX: [
                { label: 'Export. Netas (NX)', data: labels.map(y => (p.X0 + p.x_ext * p.Ystar - (p.n / 2) * p.e) - (p.IM0 + p.m * y + (p.n / 2) * p.e)), borderColor: '#c2410c' },
                { label: 'Equilibrio NX=0', data: labels.map(() => 0), borderColor: '#94a3b8', borderDash: [2, 2] }
            ],
            Theory: [
                { label: 'S Nacional - I', data: labels.map(y => {
                    const Ti = p.T0 + p.t * y;
                    const Ci = p.C0 + p.c * (y - Ti);
                    const Ii = p.I0 + p.b * y - p.g * p.i;
                    const BSi = Ti - p.G;
                    const Spi = y - Ti - Ci;
                    return (Spi + BSi) - Ii;
                }), borderColor: '#475569' },
                { label: 'NX', data: labels.map(y => (p.X0 + p.x_ext * p.Ystar - (p.n / 2) * p.e) - (p.IM0 + p.m * y + (p.n / 2) * p.e)), borderColor: '#c2410c', borderDash: [4, 4] }
            ]
        };

        const equilibriumAnnotation = {
            type: 'line',
            xMin: res.Y_eq,
            xMax: res.Y_eq,
            borderColor: '#1e40af',
            borderWidth: 2,
            borderDash: [6, 6],
            label: {
                display: true,
                content: 'Y* = ' + Math.round(res.Y_eq).toLocaleString(),
                position: 'end',
                backgroundColor: '#1e40af',
                color: 'white',
                font: { size: 11, weight: 'bold' }
            }
        };

        Object.keys(datasets).forEach(id => {
            const ctx = document.getElementById('chart' + id).getContext('2d');
            const currentAnnotations = { eq: equilibriumAnnotation };

            if (charts[id]) {
                charts[id].data.labels = labels;
                charts[id].data.datasets = datasets[id];
                charts[id].options.scales.x.max = max_X;
                charts[id].options.plugins.annotation.annotations = currentAnnotations;
                charts[id].update('none');
            } else {
                charts[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: datasets[id] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, animation: false,
                        elements: { point: { radius: 0 } },
                        scales: { 
                            y: { 
                                beginAtZero: false,
                                ticks: { callback: v => v.toLocaleString() }
                            },
                            x: { 
                                type: 'linear',
                                min: 0,
                                max: max_X,
                                ticks: { callback: v => v.toLocaleString() }
                            }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } },
                            title: { display: true, text: chartTitles[id], color: '#1e293b', font: { size: 14, weight: 'bold' } },
                            annotation: { annotations: currentAnnotations }
                        }
                    }
                });
            }
        });
    }

    window.onload = () => { update(); };
function exportToCSV() {
    const p = getParams();
    const res = calculate(p);
    
    // Preparar los datos (Etiqueta, Valor)
    const data = [
        ["REPORTE DE ESCENARIO - MACROECONOMIA II"],
        ["Fecha", new Date().toLocaleString()],
        [""],
        ["PARAMETROS DE ENTRADA"],
        ["Consumo autonomo (C0)", p.C0],
        ["Propension marginal (c)", p.c],
        ["Inversion autonoma (I0)", p.I0],
        ["Sensibilidad inversion (b)", p.b],
        ["Tasa de interes (i)", p.i],
        ["Gasto publico (G)", p.G],
        ["Tasa impositiva (t)", p.t],
        ["Exportaciones (X0)", p.X0],
        ["PIB Mundial (Y*)", p.Ystar],
        ["Tipo de cambio (e)", p.e],
        [""],
        ["RESULTADOS CALCULADOS"],
        ["Multiplicador (alpha)", res.alpha.toFixed(4)],
        ["PIB Equilibrio (Y*)", Math.round(res.Y_eq)],
        ["Consumo (C)", Math.round(res.C)],
        ["Inversion (I)", Math.round(res.I)],
        ["Saldo Fiscal (BS)", Math.round(res.BS)],
        ["Exportaciones Netas (NX)", Math.round(res.NX)],
        ["Ahorro Privado (Sp)", Math.round(res.Sp)],
        ["Ahorro Nacional (S)", Math.round(res.Sp + res.BS)],
        ["Ingreso Disponible (Yd)", Math.round(res.Y_eq - res.T)]
    ];

    // Convertir array a formato CSV
    let csvContent = "data:text/csv;charset=utf-8," 
        + data.map(e => e.join(",")).join("\n");

    // Crear link de descarga
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Escenario_Y_${Math.round(res.Y_eq)}.csv`);
    document.body.appendChild(link);

    link.click();
    document.body.removeChild(link);
}
function exportToCSV() {
    const p = getParams();
    const res = calculate(p);
    const Yd = res.Y_eq - res.T;
    const S_nacional = res.Sp + res.BS;
    
    // Encabezados del CSV
    let csvContent = "Variable,Escenario Actual";
    
    // Si existe un escenario base, a√±adimos la columna y la diferencia
    if (baseScenario) {
        csvContent += ",Escenario Base,Diferencia (Actual - Base)";
    }
    csvContent += "\n";

    // Definici√≥n de las filas a exportar
    const rows = [
        ["Multiplicador (alpha)", res.alpha.toFixed(2), baseScenario ? baseScenario.alpha.toFixed(2) : null],
        ["PIB de Equilibrio (Y*)", res.Y_eq.toFixed(2), baseScenario ? baseScenario.Y_eq.toFixed(2) : null],
        ["Consumo (C)", res.C.toFixed(2), baseScenario ? baseScenario.C.toFixed(2) : null],
        ["Inversion (I)", res.I.toFixed(2), baseScenario ? baseScenario.I.toFixed(2) : null],
        ["Saldo Fiscal (BS)", res.BS.toFixed(2), baseScenario ? baseScenario.BS.toFixed(2) : null],
        ["Exportaciones Netas (NX)", res.NX.toFixed(2), baseScenario ? baseScenario.NX.toFixed(2) : null],
        ["Ahorro Privado (Sp)", res.Sp.toFixed(2), baseScenario ? baseScenario.Sp.toFixed(2) : null],
        ["Ahorro Nacional (S)", S_nacional.toFixed(2), baseScenario ? (baseScenario.Sp + baseScenario.BS).toFixed(2) : null]
    ];

    // Procesar cada fila
    rows.forEach(row => {
        let line = `${row[0]},${row[1]}`;
        if (baseScenario) {
            const baseVal = parseFloat(row[2]);
            const actualVal = parseFloat(row[1]);
            const diff = actualVal - baseVal;
            line += `,${baseVal},${diff.toFixed(2)}`;
        }
        csvContent += line + "\n";
    });

    // Crear y descargar el archivo
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `Simulacion_Macro_UAC_${new Date().getTime()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
