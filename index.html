<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macroeconom√≠a - Dr. Adri√°n Eduardo Pech Quijano</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        :root { --blue: #1e40af; --red: #b91c1c; --green: #065f46; --orange: #c2410c; --slate: #334155; --uac-gold: #b89c5e; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; margin: 0; padding: 20px; color: #1e293b; }
        
        #welcome-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(248, 250, 252, 0.98);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #exercise-guide {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .guide-card {
            background: white;
            max-width: 650px;
            width: 95%;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-height: 85vh;
            overflow-y: auto;
        }

        .welcome-card {
            background: white;
            max-width: 850px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .header-inst { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--slate); padding-bottom: 15px; }
        .header-inst h1 { margin: 0; font-size: 1.6rem; color: var(--slate); }
        .header-inst p { margin: 5px 0; font-weight: 500; }
        
        .uac-shield { 
            width: 120px; 
            height: auto; 
            margin: 0 auto 15px auto; 
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .wrapper { 
            max-width: 1500px; 
            margin: auto; 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 20px; 
            height: calc(100vh - 180px);
        }
        .sidebar { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            height: calc(100vh - 220px); 
            overflow-y: auto; 
            position: sticky; 
            top: 0;
        }
        .main-content { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            overflow-y: auto; 
            padding-right: 10px;
        }

        .formula-card { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.4; border-left: 4px solid var(--blue); }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-weight: 600; font-size: 0.8rem; margin-bottom: 3px; color: var(--slate); }
        input[type="range"] { width: 100%; cursor: pointer; }
        .val-display { float: right; color: var(--blue); font-weight: bold; }
        
        .delta-badge { font-size: 0.7rem; padding: 1px 5px; border-radius: 4px; margin-left: 5px; font-weight: 800; display: inline-block; vertical-align: middle; }
        .delta-pos { background: #dcfce7; color: #166534; }
        .delta-neg { background: #fee2e2; color: #991b1b; }

        .results-summary { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #cbd5e1; }
        .res-item { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: var(--slate); }
        .res-val { font-weight: bold; }

        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 380px; }
        .logic-panel { background: #fff; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; }
        
        .instructional-content h3 { color: var(--blue); margin-top: 20px; font-size: 1.2rem; border-left: 4px solid var(--uac-gold); padding-left: 10px; }
        .instructional-content p, .instructional-content li { font-size: 0.95rem; line-height: 1.6; color: #334155; }
        .instructional-content strong { color: var(--blue); }
        
        .eco-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .eco-table th, .eco-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: left; }
        .eco-table tr:hover { background-color: #f8fafc; }

        .theory-section {
            background: #fdfdfd;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        .theory-text { flex: 1.2; }
        .theory-img { flex: 0.8; height: 250px; background: white; border-radius: 8px; padding: 10px; border: 1px solid #eee; }
        
        #stability-alert { background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; }
        .btn-panic { background: #991b1b; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn-action { background: var(--slate); color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn-guide { background: var(--uac-gold); color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 8px; transition: 0.3s; }
        .btn-guide:hover { background: #9c844a; }
        .btn-start { background: var(--blue); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 25px; transition: 0.3s; }
        .btn-start:hover { background: #172554; }

        .academic-credits {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-top: 10px;
            border-top: 5px solid var(--uac-gold);
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 25px;
            align-items: center;
        }
        .credit-info h4 { margin: 0 0 8px 0; color: var(--blue); font-size: 1.1rem; }
        .credit-info p { margin: 4px 0; font-size: 0.85rem; color: var(--slate); }
        .credit-logo { text-align: center; border-right: 1px solid #e2e8f0; padding-right: 20px; }
        
        /* Estilo para los ejercicios */
        .exercise-item { margin-bottom: 15px; padding: 10px; border-left: 4px solid var(--uac-gold); background: #f8fafc; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>

<div id="welcome-overlay">
    <div class="welcome-card">
        <div class="header-inst">
            <img src="uac-logo-2020-sm.png" alt="Escudo Universidad Aut√≥noma de Campeche" class="uac-shield">
            <h1>Universidad Aut√≥noma de Campeche</h1>
            <p>Facultad de Ciencias Sociales | Licenciatura en Econom√≠a</p>
            <p style="color: var(--blue); font-size: 1.1rem;">Macroeconom√≠a</p>
            <p>Autor: <strong>Dr. Adri√°n Eduardo Pech Quijano</strong></p>
            <p style="font-size: 0.9rem; color: var(--slate);">Fecha: 26 de enero de 2026</p>
        </div>
        
        <div class="instructional-content">
            <h3>Descripci√≥n del material inform√°tico e in√©dito</h3>
            <p>Este software educativo interactivo representa un <strong>objeto de aprendizaje (OA)</strong> original, desarrollado para modelar de forma algor√≠tmica y visual el equilibrio en una econom√≠a abierta. A diferencia de las gr√°ficas est√°ticas, este material permite la <strong>experimentaci√≥n en tiempo real</strong> con variables ex√≥genas, proporcionando una soluci√≥n num√©rica instant√°nea a las identidades macroecon√≥micas fundamentales.</p>
            
            <h3>Gu√≠a instruccional del objeto de aprendizaje</h3>
            
            <p><strong>1. Objetivos de aprendizaje:</strong></p>
            <ul>
                <li>Identificar y cuantificar el efecto del <strong>multiplicador del gasto (Œ±)</strong> bajo un r√©gimen impositivo proporcional y propensi√≥n marginal a importar.</li>
                <li>Simular escenarios de pol√≠tica fiscal expansiva y contractiva para observar su impacto en el producto interno bruto (PIB).</li>
                <li>Analizar la interacci√≥n entre el ahorro nacional, la inversi√≥n y el saldo de la cuenta comercial (Identidad S - I = NX).</li>
            </ul>

            <p><strong>2. Desarrollo del proceso:</strong></p>
            <ul>
                <li><strong>Manipulaci√≥n de variables:</strong> Utilice los controles deslizantes de la izquierda para modificar el gasto (G), impuestos (T), tipo de cambio (e) y el ingreso externo (Y*).</li>
                <li><strong>Observaci√≥n din√°mica:</strong> Analice c√≥mo los puntos de equilibrio se desplazan simult√°neamente en los cuatro gr√°ficos (demanda agregada, presupuesto, sector externo y ahorro-inversi√≥n).</li>
                <li><strong>Escenarios comparativos:</strong> Utilice el bot√≥n "Fijar escenario base" para establecer una l√≠nea de referencia y visualizar los cambios marginales (badges verdes/rojos) tras nuevas modificaciones.</li>
            </ul>

            <p><strong>3. Conclusi√≥n y verificaci√≥n:</strong></p>
            <p>El proceso culmina en la <strong>consolidaci√≥n del equilibrio</strong>. El estudiante debe verificar en la tabla inferior que, independientemente de los choques aplicados, la identidad macroecon√≥mica se mantiene constante, demostrando que el d√©ficit comercial debe ser financiado necesariamente por un exceso de inversi√≥n sobre el ahorro nacional o viceversa.</p>
        </div>

        <button class="btn-start" onclick="document.getElementById('welcome-overlay').style.display='none'">
            Ingresar al simulador
        </button>
    </div>
</div>

<div id="exercise-guide" onclick="this.style.display='none'">
    <div class="guide-card" onclick="event.stopPropagation()">
        <h2 style="color: var(--blue); border-bottom: 2px solid var(--uac-gold); padding-bottom: 10px; margin-top: 0;">Gu√≠a de ejercicios pr√°cticos</h2>
        <div style="font-size: 0.95rem; line-height: 1.6; color: var(--slate);">
            
            <div class="exercise-item">
                <strong>Ejercicio 1: Sensibilidad del consumo y multiplicador</strong><br>
                1. Haga clic en <b>"Fijar escenario base"</b>.<br>
                2. Aumente la <b>Propensi√≥n marginal a consumir (c)</b> de 0.60 a 0.80.<br>
                3. Observe la tarjeta naranja: ¬øQu√© sucedi√≥ con el <b>Multiplicador (Œ±)</b>? <br>
                4. Ahora aumente el <b>Gasto (G)</b> en 200 unidades. Compare el crecimiento del PIB con este multiplicador alto frente al escenario original.
            </div>

            <div class="exercise-item">
                <strong>Ejercicio 2: Inversi√≥n, tasa de inter√©s y pol√≠tica monetaria</strong><br>
                1. Restablezca el escenario base. En este modelo, la inversi√≥n se define como <b>I = I‚ÇÄ + bY - gi</b>.<br>
                2. Suponga que el banco central reduce la <b>Tasa de inter√©s (i)</b>. Observe c√≥mo reacciona la inversi√≥n y el PIB.<br>
                3. Observe el <b>Gr√°fico IV (S-I)</b>: ¬øC√≥mo afecta una mayor inversi√≥n al equilibrio entre el ahorro nacional y las exportaciones netas?
            </div>
            
            <div class="exercise-item">
                <strong>Ejercicio 3: El consumo aut√≥nomo y la demanda agregada</strong><br>
                1. Restablezca el simulador y fije base. Aumente el <b>Consumo aut√≥nomo (C‚ÇÄ)</b> a 750.<br>
                2. Observe el Gr√°fico I: ¬øC√≥mo se desplaza la curva DA? <br>
                3. Verifique en la tabla de identidades el nuevo nivel de <b>Ahorro privado</b>. ¬øPor qu√© un mayor consumo aut√≥nomo reduce inicialmente el ahorro si el ingreso no aumenta proporcionalmente?
            </div>
            
            <div class="exercise-item">
                <strong>Ejercicio 4: Pol√≠tica fiscal y d√©ficits gemelos</strong><br>
                1. Reduzca la <b>Tasa impositiva (t)</b> a 0.10 y aumente <b>G</b> a 2500.<br>
                2. Observe el <b>Saldo fiscal</b> y las <b>Exportaciones netas (NX)</b>. <br>
                3. Analice c√≥mo el aumento del ingreso (estimulado por la baja de impuestos y el consumo) termina deteriorando la balanza comercial.
            </div>

            <div class="exercise-item">
                <strong>Ejercicio 5: Identidad S-I en econom√≠a abierta</strong><br>
                1. Realice cambios en <b>Y* (PIB mundial)</b> y <b>e (Tipo de cambio)</b>.<br>
                2. Dir√≠jase a la √∫ltima fila de la tabla: <b>Identidad S-I</b>.<br>
                3. Compruebe que la diferencia entre ahorro nacional e inversi√≥n siempre iguala a NX. Explique c√≥mo el sector externo financia las brechas de ahorro dom√©stico.
            </div>
        </div>
        <button class="btn-action" style="margin-top: 20px; background: var(--blue);" onclick="document.getElementById('exercise-guide').style.display='none'">Continuar con la simulaci√≥n</button>
    </div>
</div>

<div class="header-inst">
    <img src="uac-logo-2020-sm.png" alt="Escudo UAC" class="uac-shield" style="width: 80px;">
    <h1>Universidad Aut√≥noma de Campeche</h1>
    <p>Facultad de Ciencias Sociales | Macroeconom√≠a</p>
    <p>Autor: Dr. Adri√°n Eduardo Pech Quijano</p>
</div>

<div class="wrapper">
    <div class="sidebar">
        <div class="formula-card">
            <strong>Ecuaciones del modelo:</strong><br>
            ‚Ä¢ C = C‚ÇÄ + c(Y - T)<br>
            ‚Ä¢ I = I‚ÇÄ + bY - gi<br>
            ‚Ä¢ T = T‚ÇÄ + tY<br>
            ‚Ä¢ IM = IM‚ÇÄ + mY + n_im * e<br>
            ‚Ä¢ X = X‚ÇÄ + x_ext * Y* - n_ex * e<br>
            ‚Ä¢ NX = X - IM<br>
            ‚Ä¢ DA = C + I + G + NX<br>
            ‚Ä¢ Œ± = 1 / [1 - c(1-t) - b + m]
        </div>
        
        <div class="control-group">
            <label>Consumo aut√≥nomo (C‚ÇÄ): <span id="vC0" class="val-display">250</span></label>
            <input type="range" id="iC0" min="0" max="1000" step="50" value="250" oninput="update()">
        </div>
        <div class="control-group">
            <label>Propensi√≥n marginal a consumir (c): <span id="vc" class="val-display">0.60</span></label>
            <input type="range" id="ic" min="0.1" max="0.9" step="0.05" value="0.60" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <div class="control-group">
            <label>Inversi√≥n aut√≥noma (I‚ÇÄ): <span id="vI0" class="val-display">500</span></label>
            <input type="range" id="iI0" min="0" max="1500" step="50" value="500" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad al ingreso (b): <span id="vb" class="val-display">0.20</span></label>
            <input type="range" id="ib" min="0" max="0.4" step="0.01" value="0.20" oninput="update()">
        </div>
        <div class="control-group">
            <label>Tasa de inter√©s (i): <span id="vi" class="val-display">0.05</span></label>
            <input type="range" id="ii" min="0.01" max="0.2" step="0.01" value="0.05" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad al inter√©s (g): <span id="vg" class="val-display">1000</span></label>
            <input type="range" id="ig" min="0" max="5000" step="100" value="1000" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

        <div class="control-group">
            <label>Gasto p√∫blico (G): <span id="vG" class="val-display">2000</span></label>
            <input type="range" id="iG" min="500" max="4000" step="100" value="2000" oninput="update()">
        </div>
        <div class="control-group">
            <label>Impuestos aut√≥nomos (T‚ÇÄ): <span id="vT0" class="val-display">0</span></label>
            <input type="range" id="iT0" min="0" max="1000" step="50" value="0" oninput="update()">
        </div>
        <div class="control-group">
            <label>Tasa impositiva (t): <span id="vt" class="val-display">0.20</span></label>
            <input type="range" id="it" min="0" max="0.4" step="0.01" value="0.20" oninput="update()">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

        <div class="control-group">
            <label>Exportaciones aut√≥nomas (X‚ÇÄ): <span id="vX0" class="val-display">500</span></label>
            <input type="range" id="iX0" min="0" max="2000" step="100" value="500" oninput="update()">
        </div>
        <div class="control-group">
            <label>Sensibilidad ingreso externo (x_ext): <span id="vx_ext" class="val-display">0.20</span></label>
            <input type="range" id="ix_ext" min="0" max="0.5" step="0.01" value="0.20" oninput="update()">
        </div>
        <div class="control-group">
            <label>PIB mundial (Y*): <span id="vYstar" class="val-display">5000</span></label>
            <input type="range" id="iYstar" min="2000" max="8000" step="100" value="5000" oninput="update()">
        </div>
        <div class="control-group">
            <label>Importaciones aut√≥nomas (IM‚ÇÄ): <span id="vIM0" class="val-display">100</span></label>
            <input type="range" id="iIM0" min="0" max="1000" step="50" value="100" oninput="update()">
        </div>
        <div class="control-group">
            <label>Propensi√≥n marginal a importar (m): <span id="vm" class="val-display">0.20</span></label>
            <input type="range" id="im" min="0.05" max="0.5" step="0.01" value="0.20" oninput="update()">
        </div>
        <div class="control-group">
            <label>Tipo de cambio (e): <span id="ve" class="val-display">1.0</span></label>
            <input type="range" id="ie" min="0.5" max="2.5" step="0.1" value="1.0" oninput="update()">
        </div>
        
        <button onclick="document.getElementById('exercise-guide').style.display='flex'" class="btn-guide">üìñ Gu√≠a de ejercicios</button>
        <button onclick="saveBase()" class="btn-action">Fijar escenario base</button>
        <button onclick="triggerCrisis()" class="btn-panic">Simular crisis mundial</button>
        <button onclick="exportData()" class="btn-action" style="background:#059669">Exportar reporte txt</button>
        
        <div class="formula-card" style="margin-top:20px; border-left-color: var(--orange);">
            <strong>Multiplicador (Œ±): <span id="valAlpha">1.92</span></strong><br>
            <small>Basado en propensiones marginales y tasa impositiva.</small>
        </div>
        <div id="stability-alert"></div>
    </div>

    <div class="main-content">
        <div class="chart-box"><canvas id="chartDA"></canvas></div>
        <div class="chart-box"><canvas id="chartT"></canvas></div>
        <div class="chart-box"><canvas id="chartNX"></canvas></div>
        <div class="chart-box"><canvas id="chartS"></canvas></div>
        
        <div class="logic-panel">
            <h3>Desglose de identidades econ√≥micas</h3>
            <table class="eco-table">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Estructura de la ecuaci√≥n</th>
                        <th>Valor actual</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="eco-body"></tbody>
            </table>
        </div>

        <div class="theory-section">
            <div class="theory-text">
                <h3 style="color: var(--blue); margin-top: 0;">Fundamento: el equilibrio de la demanda agregada</h3>
                <p style="font-size: 0.85rem; line-height: 1.4; color: var(--slate);">
                    El equilibrio macroecon√≥mico ocurre cuando la <strong>producci√≥n (Y)</strong> iguala a la <strong>demanda agregada (DA)</strong>. 
                    En este modelo, cualquier cambio en los componentes aut√≥nomos desplaza la curva DA, afectando el ingreso y los saldos gemelos.
                    <br><br>
                    <strong>Pendiente DA = [c(1-t) + b - m]</strong>
                </p>
            </div>
            <div class="theory-img">
                <canvas id="chartTheory"></canvas>
                <p style="font-size: 0.7rem; color: #64748b; text-align: center; margin-top: 5px;"><em>Esquema de determinaci√≥n del ingreso de equilibrio</em></p>
            </div>
        </div>

        <div class="academic-credits">
            <div class="credit-logo">
                <img src="uac-logo-2020-sm.png" alt="Escudo UAC" style="width: 80px; opacity: 0.8;">
                <p style="font-weight: bold; margin-top: 8px; color: var(--slate); font-size: 0.7rem;">UAC ECONOM√çA</p>
            </div>
            <div class="credit-info">
                <h4>Autor√≠a y cr√©ditos</h4>
                <p><strong>Autor:</strong> Dr. Adri√°n Eduardo Pech Quijano</p>
                <p><strong>Instituci√≥n:</strong> Universidad Aut√≥noma de Campeche (UACAM)</p>
                <p><strong>Facultad:</strong> Ciencias Sociales | Licenciatura en Econom√≠a</p>
                <p style="font-size: 0.75rem; color: #64748b; font-style: italic; margin-top: 10px;">
                    ¬© 2026. Material educativo in√©dito dise√±ado como simulador de macroeconom√≠a.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    let base = null;
    let charts = {};

    const chartTitles = {
        DA: "I. Equilibrio del mercado de bienes (Modelo 45¬∞)",
        T: "II. Balance presupuestario (Gasto vs. Recaudaci√≥n)",
        NX: "III. Curva de exportaciones netas (Sector externo)",
        S: "IV. Equilibrio ahorro-inversi√≥n (Identidad S-I)",
        Theory: "Determinaci√≥n te√≥rica del ingreso"
    };

    function triggerCrisis() {
        document.getElementById('iYstar').value = 2500;
        document.getElementById('ie').value = 2.0;
        document.getElementById('ii').value = 0.15;
        update();
    }

    function exportData() {
        const cur = calc();
        const content = `REPORTE MACROECON√ìMICO - UAC\n----------------------------------\nTITULAR: DR. ADRI√ÅN EDUARDO PECH QUIJANO\nPIB Total (Y): ${Math.round(cur.Y)}\nMultiplicador: ${cur.alpha.toFixed(2)}\nConsumo (C): ${Math.round(cur.C)}\nInversi√≥n (I): ${Math.round(cur.I)}\nSaldo Comercial (NX): ${Math.round(cur.NX)}`;
        const blob = new Blob([content], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'reporte_economico.txt';
        a.click();
    }

    function calc() {
        const G = +document.getElementById('iG').value;
        const T0 = +document.getElementById('iT0').value;
        const t = +document.getElementById('it').value;
        const e = +document.getElementById('ie').value;
        const Ystar = +document.getElementById('iYstar').value;
        const C0 = +document.getElementById('iC0').value; 
        const c = +document.getElementById('ic').value;   
        const I0 = +document.getElementById('iI0').value;
        const b = +document.getElementById('ib').value;
        const i = +document.getElementById('ii').value;
        const g = +document.getElementById('ig').value;
        const m = +document.getElementById('im').value;
        
        const X0 = +document.getElementById('iX0').value;
        const x_ext = +document.getElementById('ix_ext').value;
        const IM0 = +document.getElementById('iIM0').value;
        
        const X_total = X0 + (x_ext * Ystar) - (100 * e);
        const alpha = 1 / (1 - (c * (1 - t)) - b + m); 
        const A_const = C0 - (c * T0) + I0 - (g * i) + G + X_total - (IM0 + 100 * e);
        const pendiente = c * (1 - t) + b;
        
        const Y = Math.max(0, A_const * alpha);
        const T = T0 + (t * Y);
        const C = C0 + c * (Y - T);
        const I = I0 + b * Y - g * i;
        const X = X_total;
        const IM = IM0 + m * Y + 100 * e;
        const NX = X - IM;
        const Spriv = (Y - T) - C;
        const Spub = T - G;
        const Snac = Spriv + Spub;
        
        return { G, T0, t, e, Ystar, C0, c, I0, b, i, g, Y, T, C, I, X, IM, NX, Spriv, Spub, Snac, A_const, pendiente, alpha, m, X0, x_ext, IM0 };
    }

    function saveBase() { base = calc(); update(); }

    function update() {
        const cur = calc();
        if (!base) base = {...cur};
        
        const fmt = (v) => Math.round(v).toLocaleString();

        const getDeltaLabel = (current, baseVal, isDec = false) => {
            const diff = isDec ? (current - baseVal) : Math.round(current - baseVal);
            if (Math.abs(diff) < 0.001) return "";
            const cls = diff > 0 ? 'delta-pos' : 'delta-neg';
            return `<span class="delta-badge ${cls}">${diff > 0 ? '+' : ''}${isDec ? diff.toFixed(2) : diff}</span>`;
        };

        ['G','T0','t','e','Ystar','C0','c','I0','b','i','g','m','X0','x_ext','IM0'].forEach(k => {
            const el = document.getElementById('v'+k);
            if(el) {
                const decimales = (k === 't' || k === 'e' || k === 'c' || k === 'b' || k === 'i' || k === 'm' || k === 'x_ext');
                el.innerHTML = `${decimales ? cur[k].toFixed(2) : cur[k]}${getDeltaLabel(cur[k], base[k], decimales)}`;
            }
        });

        document.getElementById('valAlpha').innerText = cur.alpha.toFixed(2);

        document.getElementById('eco-body').innerHTML = `
            <tr><td><b>PIB (Y)</b></td><td>Y = Œ± * A_aut√≥nomo</td><td><b>${fmt(cur.Y)}</b></td><td>Equilibrio</td></tr>
            <tr><td>Consumo (C)</td><td>C = C‚ÇÄ + c(Y - T)</td><td>${fmt(cur.C)}</td><td>Hogares</td></tr>
            <tr><td>Inversi√≥n (I)</td><td>I = I‚ÇÄ + bY - gi</td><td>${fmt(cur.I)}</td><td>Capital</td></tr>
            <tr><td>Ahorro privado (S_p)</td><td>(Y - T) - C</td><td>${fmt(cur.Spriv)}</td><td>Hogares</td></tr>
            <tr><td>Saldo fiscal (S_g)</td><td>(T‚ÇÄ + tY) - G</td><td style="color:${cur.Spub >= 0 ? 'green' : 'red'}"><b>${fmt(cur.Spub)}</b></td><td>${cur.Spub >= 0 ? 'Super√°vit' : 'D√©ficit'}</td></tr>
            <tr><td>Ahorro nacional (S)</td><td>S_p + S_g</td><td>${fmt(cur.Snac)}</td><td>Nacional</td></tr>
            <tr><td>Sector externo (NX)</td><td>NX = X - IM</td><td style="color:${cur.NX >= 0 ? 'green' : 'red'}"><b>${fmt(cur.NX)}</b></td><td>${cur.NX >= 0 ? 'Super√°vit' : 'D√©ficit'}</td></tr>
            <tr style="background: #f1f5f9; font-weight: bold;"><td>Identidad S-I</td><td>(S - I) = NX</td><td>${fmt(cur.Snac - cur.I)} = ${fmt(cur.NX)}</td><td style="color:var(--blue)">Verificado</td></tr>`;
            
        render(cur);
    }

    function render(cur) {
        const maxRange = Math.max(15000, cur.Y * 1.5);
        const labels = Array.from({length: 21}, (_, i) => i * (maxRange / 20));
        const xPos = cur.Y;
        
        const datasets = {
            DA: [{ label: 'DA', data: labels.map(y => (cur.C0 - cur.c*cur.T0 + cur.I0 - cur.g*cur.i + cur.G + cur.X - (cur.IM0 + 100*cur.e)) + (cur.pendiente - cur.m) * y), borderColor: '#2563eb', tension: 0 }, { label: '45¬∞', data: labels, borderColor: '#cbd5e1', borderDash: [5,5], tension: 0 }],
            T: [{ label: 'T (Recaudaci√≥n)', data: labels.map(y => cur.T0 + cur.t * y), borderColor: '#059669', tension: 0 }, { label: 'G (Gasto)', data: labels.map(() => cur.G), borderColor: '#dc2626', borderDash: [4,4], tension: 0 }],
            NX: [{ label: 'NX', data: labels.map(y => cur.X - (cur.IM0 + cur.m * y + 100 * cur.e)), borderColor: '#7c3aed', tension: 0, fill: { target: 'origin', above: 'rgba(124, 58, 237, 0.1)', below: 'rgba(220, 38, 38, 0.1)' } }],
            S: [{ label: 'S_nac', data: labels.map(y => { 
                let t_y = cur.T0 + cur.t * y; 
                let c_y = cur.C0 + cur.c * (y - t_y); 
                return (y - t_y - c_y) + (t_y - cur.G); 
            }), borderColor: '#059669', tension: 0 }, { label: 'I', data: labels.map(y => cur.I0 + cur.b * y - cur.g * cur.i), borderColor: '#ea580c', tension: 0 }],
            Theory: [{ label: 'DA (Demanda)', data: labels.map(y => (cur.A_const/1.5) + (cur.pendiente - cur.m) * y), borderColor: '#2563eb', tension: 0 }, { label: 'Y = DA', data: labels, borderColor: '#334155', tension: 0 }]
        };

        ['DA', 'T', 'NX', 'S', 'Theory'].forEach((id) => {
            const ctx = document.getElementById('chart' + (id === 'Theory' ? 'Theory' : id));
            const valY = id === 'DA' ? cur.Y : (id === 'T' ? cur.T : (id === 'NX' ? cur.NX : (id === 'Theory' ? cur.Y : cur.Snac)));
            
            let annotations = {
                equilibrioLine: {
                    type: 'line', xMin: xPos, xMax: xPos,
                    borderColor: 'rgba(30, 64, 175, 0.4)', borderWidth: 2, borderDash: [6, 6],
                    label: {
                        display: true, content: 'Y: ' + Math.round(cur.Y), position: 'start',
                        backgroundColor: 'rgba(30, 64, 175, 0.8)', color: 'white', font: { size: 10 }
                    }
                },
                dot: {
                    type: 'point', xValue: xPos, yValue: valY,
                    backgroundColor: 'var(--blue)', radius: 5, borderColor: 'white', borderWidth: 2
                }
            };

            if (id === 'NX') {
                annotations.zeroLine = {
                    type: 'line', yMin: 0, yMax: 0,
                    borderColor: '#64748b', borderWidth: 2,
                    label: {
                        display: true, content: 'Equilibrio comercial (NX=0)', position: 'end',
                        backgroundColor: '#64748b', color: 'white', font: { size: 9 }
                    }
                };
                annotations.textEstado = {
                    type: 'label', xValue: maxRange * 0.5, yValue: cur.NX >= 0 ? maxRange * 0.1 : -maxRange * 0.1,
                    content: cur.NX >= 0 ? 'SUPER√ÅVIT COMERCIAL' : 'D√âFICIT COMERCIAL',
                    color: cur.NX >= 0 ? '#065f46' : '#b91c1c',
                    font: { size: 14, weight: 'bold' }
                };
            }

            if (id === 'T') {
                annotations.textEstado = {
                    type: 'label', xValue: maxRange * 0.5, yValue: maxRange * 0.4,
                    content: cur.Spub >= 0 ? 'SUPER√ÅVIT FISCAL' : 'D√âFICIT FISCAL',
                    color: cur.Spub >= 0 ? '#065f46' : '#b91c1c',
                    font: { size: 14, weight: 'bold' }
                };
            }

            if (charts[id]) {
                charts[id].data.labels = labels;
                charts[id].data.datasets = datasets[id];
                charts[id].options.plugins.annotation.annotations = annotations;
                charts[id].update('none');
            } else {
                charts[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: datasets[id] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, animation: false,
                        elements: { point: { radius: 0 } },
                        scales: { 
                            y: { display: id !== 'Theory', beginAtZero: false },
                            x: { 
                                display: id !== 'Theory', 
                                title: { display: true, text: 'Ingreso (Y)' },
                                ticks: { callback: function(value) { return Math.round(this.getLabelForValue(value)); } }
                            }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } },
                            title: { display: true, text: chartTitles[id], color: '#1e293b', font: { size: 14, weight: 'bold' } },
                            annotation: { annotations: annotations }
                        }
                    }
                });
            }
        });
    }

    // Inicializaci√≥n
    window.onload = () => { update(); };
</script>

</body>
</html>
